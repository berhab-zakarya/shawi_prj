name: ğŸ”„ Reload NGINX Config Only

on:
  push:
    branches:
      - master

jobs:
  reload-nginx:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ” Connect & Reload NGINX
        run: |
          ssh -o StrictHostKeyChecking=no root@31.97.182.92 << 'EOF'
            echo "ğŸš€ Connected to VPS"
            cd /opt/elshawi_platform/shawi_prj

            echo "ğŸ” Checking nginx container name..."
            docker ps --format "table {{.Names}}\t{{.Image}}"

            echo "ğŸ” Reloading nginx config..."
            docker-compose -f docker-compose.prod.yml exec -T nginx nginx -s reload

            echo "âœ… NGINX config reloaded successfully!"

# name: ğŸš€ Deploy to Hostinger (Ultra Fast)

# on:
#   push:
#     branches:
#       - master

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Add SSH key
#         run: |
#           mkdir -p ~/.ssh
#           echo "${{ secrets.HOSTINGER_SSH_KEY }}" > ~/.ssh/id_rsa
#           chmod 600 ~/.ssh/id_rsa
#           ssh-keyscan -H 31.97.182.92 >> ~/.ssh/known_hosts

#       - name: Deploy to Hostinger
#         run: |
#           ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=3 root@31.97.182.92 << 'EOF'
#             set -e

#             echo "ğŸš€ Starting ultra-fast deployment..."

#             REPO_DIR="/opt/elshawi_platform/shawi_prj"

#             # Quick repository update
#             if [ ! -d "$REPO_DIR" ]; then
#               echo "ğŸ“‚ Creating project directory..."
#               mkdir -p /opt/elshawi_platform
#               cd /opt/elshawi_platform
#               git clone --depth 1 https://github.com/berhab-zakarya/shawi_prj.git shawi_prj
#             else
#               echo "ğŸ”„ Quick repository update..."
#               cd "$REPO_DIR"
#               # Only fetch what we need
#               git fetch origin master --depth 1
#               git reset --hard origin/master
#             fi

#             cd "$REPO_DIR"

#             # Check if .env.prod exists
#             if [ ! -f .env.prod ]; then
#               echo "âŒ .env.prod not found! Deployment aborted."
#               exit 1
#             fi

#             echo "ğŸ” Checking for actual changes..."
#             # Get current running image IDs to compare
#             CURRENT_BACKEND_ID=$(docker-compose -f docker-compose.prod.yml images -q backend 2>/dev/null || echo "none")
            
#             # Build only if needed with maximum optimization
#             echo "ğŸ—ï¸ Smart building with maximum cache..."
            
#             echo "ğŸ”¨ Building with optimized approach..."
            
#             # Build backend first (usually faster)
#             echo "ğŸ”¨ Building backend..."
#             docker-compose -f docker-compose.prod.yml build backend

#             # Build frontend with periodic output to keep connection alive
#             if [ -d "frontend" ]; then
#               echo "ğŸ”¨ Building frontend..."
#               # Use script to build with periodic keepalive
#               (
#                 docker-compose -f docker-compose.prod.yml build frontend &
#                 BUILD_PID=$!
                
#                 while kill -0 $BUILD_PID 2>/dev/null; do
#                   echo "â³ Still building frontend... $(date)"
#                   sleep 30
#                 done
                
#                 wait $BUILD_PID
#                 echo $? > /tmp/build_exit_code
#               ) 2>&1
              
#               # Check build result
#               BUILD_EXIT_CODE=$(cat /tmp/build_exit_code 2>/dev/null || echo "1")
#               if [ "$BUILD_EXIT_CODE" -ne 0 ]; then
#                 echo "âŒ Frontend build failed"
#                 exit 1
#               fi
#               echo "âœ… Frontend build completed"
#             fi

#             echo "ğŸ”„ Rolling update (zero-downtime)..."
            
#             # Use rolling update strategy instead of stopping everything
#             docker-compose -f docker-compose.prod.yml up -d --no-deps --remove-orphans
            
#             # Quick health check (reduced timeout)
#             echo "âš¡ Quick health check..."
#             timeout 60 bash -c '
#               while ! curl -f http://localhost/ >/dev/null 2>&1; do 
#                 sleep 2
#                 echo "Waiting for app..."
#               done
#             ' || {
#               echo "âŒ Quick health check failed, checking logs..."
#               docker-compose -f docker-compose.prod.yml logs --tail=20 backend
#               exit 1
#             }

#             # Clean up old unused images to save space (run in background)
#             (docker image prune -f --filter "dangling=true" &) || true

#             echo "âœ… Ultra-fast deployment completed!"
#           EOF

#       - name: Quick Verification
#         run: |
#           ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=3 root@31.97.182.92 << 'EOF'
#             cd /opt/elshawi_platform/shawi_prj
#             echo "ğŸ“Š Service status:"
#             docker-compose -f docker-compose.prod.yml ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
#           EOF